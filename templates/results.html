<!-- templates/result.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K·∫øt qu·∫£ Ph√¢n t√≠ch</title>
    {% if remaining is defined %}
    <div class="alert alert-info mt-3">
        üîë B·∫°n c√≤n <strong>{{ remaining }}</strong> l∆∞·ª£t s·ª≠ d·ª•ng cho API Key n√†y.
    </div>
    {% endif %}
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Confetti library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <!-- CSS chung v√† ri√™ng cho result -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/result.css') }}">
</head>
<body>
    <div class="container"
        {% if result and result.analysis %}
            data-analysis-present="true"
            data-meets-requirements="{{ result.analysis.meets_requirements|default(false)|tojson }}"
            data-syntax-errors-count="{{ (result.analysis.syntax_errors|default([])|length)|tojson }}"
            data-logical-errors-count="{{ (result.analysis.logical_errors|default([])|length)|tojson }}"
            data-runtime-errors-count="{{ (result.analysis.runtime_errors|default([])|length)|tojson }}"
        {% else %}
            data-analysis-present="false"
        {% endif %}
    >
        <div class="back-button-container">
            <a href="/" class="btn btn-custom-secondary back-button">¬´ Quay l·∫°i trang nh·∫≠p li·ªáu</a>
            <button class="theme-toggle-button" onclick="toggleDarkMode()">Giao di·ªán S√°ng/T·ªëi</button>
        </div>

        <div class="page-header">
            <h1>K·∫øt qu·∫£ Ph√¢n t√≠ch</h1>
        </div>

        {% if error_message %}
            <div class="alert alert-danger">{{ text_to_html(error_message) }}</div>
        {% elif result %}
            <!-- 1. Ph√¢n t√≠ch m√£ ngu·ªìn -->
            <h2 class="section-title">1. Ph√¢n t√≠ch m√£ ngu·ªìn</h2>
            <p><strong>ƒê√°nh gi√° ƒë·ªÅ b√†i:</strong>
                {% if result.analysis.meets_requirements %}‚úÖ ƒê·∫°t y√™u c·∫ßu{% else %}‚ùå Ch∆∞a ƒë·∫°t y√™u c·∫ßu{% endif %}
            </p>
            <p><strong>C√°c l·ªói ph√°t hi·ªán ƒë∆∞·ª£c:</strong></p>
            {% if result.analysis.syntax_errors %}
                <p><strong>L·ªói c√∫ ph√°p:</strong></p>
                <ul>{% for e in result.analysis.syntax_errors %}<li>{{ text_to_html(e) }}</li>{% endfor %}</ul>
            {% endif %}
            {% if result.analysis.logical_errors %}
                <p><strong>L·ªói logic:</strong></p>
                <ul>{% for e in result.analysis.logical_errors %}<li>{{ text_to_html(e) }}</li>{% endfor %}</ul>
            {% endif %}
            {% if result.analysis.runtime_errors %}
                <p><strong>L·ªói th·ªùi gian ch·∫°y ti·ªÅm ·∫©n:</strong></p>
                <ul>{% for e in result.analysis.runtime_errors %}<li>{{ text_to_html(e) }}</li>{% endfor %}</ul>
            {% endif %}

            <!-- 2. G·ª£i √Ω s·ª≠a l·ªói -->
            <h2 class="section-title">2. G·ª£i √Ω s·ª≠a l·ªói</h2>
            {% if result.suggestions %}
                {% for s in result.suggestions %}
                    <p><strong>D√≤ng {{ s.line }}:</strong> {{ text_to_html(s.error) }}</p>
                    <p><strong>ƒê·ªÅ xu·∫•t:</strong> {{ text_to_html(s.fix) }}</p>
                    {% if s.fixed_code %}
                        <pre class="bg-light p-2"><code>{{ text_to_html(s.fixed_code) }}</code></pre>
                    {% endif %}
                {% endfor %}
            {% else %}
                <p>Kh√¥ng c√≥ g·ª£i √Ω s·ª≠a l·ªói.</p>
            {% endif %}

            <!-- 3. M√¥ ph·ªèng th·ª±c thi t·ª´ng b∆∞·ªõc -->
            <h2 class="section-title">3. M√¥ ph·ªèng th·ª±c thi t·ª´ng b∆∞·ªõc</h2>
            {% if result.simulation %}
                {% if result.simulation.error_case %}
                    <div class="error-case mb-4">
                        <h4>Tr∆∞·ªùng h·ª£p l·ªói:</h4>
                        <p><strong>ƒê·∫ßu v√†o:</strong> {{ text_to_html(result.simulation.error_case.input) }}</p>
                        <div class="steps">
                            {% for step in result.simulation.error_case.steps %}
                                <div class="step {% if step.is_error_step %}error-step{% endif %}">
                                    <p><strong>B∆∞·ªõc {{ step.step }}:</strong></p>
                                    <p><code>{{ text_to_html(step.code_line) }}</code></p>
                                    <p>{{ text_to_html(step.explanation) }}</p>
                                    {% if step.variables %}
                                        <p><strong>Tr·∫°ng th√°i bi·∫øn:</strong></p>
                                        <ul>{% for n,v in step.variables.items() %}<li>{{ n }} = {{ text_to_html(v) }}</li>{% endfor %}</ul>
                                    {% endif %}
                                    {% if step.is_error_step %}
                                        <div class="error-explanation">
                                            <p><strong>‚ö†Ô∏è L·ªñI T·∫†I B∆Ø·ªöC N√ÄY:</strong></p>
                                            <p>{{ text_to_html(step.error_explanation) }}</p>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                        <p><strong>K·∫øt qu·∫£ sai:</strong> {{ text_to_html(result.simulation.error_case.result) }}</p>
                    </div>
                {% endif %}
                {% if result.simulation.corrected_case %}
                    <div class="corrected-case">
                        <h4>Tr∆∞·ªùng h·ª£p ƒë√£ s·ª≠a:</h4>
                        <p><strong>ƒê·∫ßu v√†o:</strong> {{ text_to_html(result.simulation.corrected_case.input) }}</p>
                        <div class="steps">
                            {% for step in result.simulation.corrected_case.steps %}
                                <div class="step">
                                    <p><strong>B∆∞·ªõc {{ step.step }}:</strong></p>
                                    <p><code>{{ text_to_html(step.code_line) }}</code></p>
                                    <p>{{ text_to_html(step.explanation) }}</p>
                                    {% if step.variables %}
                                        <p><strong>Tr·∫°ng th√°i bi·∫øn:</strong></p>
                                        <ul>{% for n,v in step.variables.items() %}<li>{{ n }} = {{ text_to_html(v) }}</li>{% endfor %}</ul>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                        <p><strong>K·∫øt qu·∫£ ƒë√∫ng:</strong> {{ text_to_html(result.simulation.corrected_case.result) }}</p>
                    </div>
                {% endif %}
            {% else %}
                <p>Kh√¥ng c√≥ th√¥ng tin m√¥ ph·ªèng th·ª±c thi.</p>
            {% endif %}

            <!-- 4. ƒê√°nh gi√° t·ªïng qu√°t -->
            <h2 class="section-title">4. ƒê√°nh gi√° t·ªïng qu√°t</h2>
            <p>{{ text_to_html(result.evaluation) }}</p>
        {% endif %}

        <div class="mt-4 text-center">
            <a href="/" class="btn btn-custom-secondary">¬´ Quay l·∫°i trang nh·∫≠p li·ªáu</a>
        </div>
    </div>

    <!-- JS chung v√† ri√™ng cho result -->
    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script src="{{ url_for('static', filename='js/result.js') }}"></script>
</body>
</html>
